<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Ping Pong Robot Control System Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Ping Pong Robot Control System Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="intro_sec"></a>
Introduction</h1>
<p>This documentation provides a comprehensive overview of the firmware of the Automated Ping Pong Launcher Robot which is powered by an STM32F4111 microcontroller and a custom PCB. The robot is designed for both manual and automatic operation, utilizing various motors and sensors to achieve ball launching and positioning. </p><div class="image">
<img src="pingpong_overview.jpg" alt=""/>
<div class="caption">
Ping Pong Ball Launcher</div></div>
<p>The robot features:</p><ul>
<li>Two 12V DC-gearmotors with built in encoders for accurate positioning of the robot base.</li>
<li>Two flywheel motors for launching ping pong balls.</li>
<li>TF Luna LIDAR sensor for distance measurement and object detection.</li>
<li>A BNO055 Inertial Measurement Unit (IMU) for orientation and heading information.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="features_sec"></a>
Key Features and Control Modes</h1>
<p>The robot operates under four distinct control modes, each designed for different operational scenarios:</p>
<ol type="1">
<li><b>S1: Idle Mode (<span class="tt">FSM::S1_IDLE</span>)</b> The initial state where the robot is awaiting commands. From this mode, you can transition to other operational modes. Commands:</li>
</ol>
<ul>
<li>'MODEX' : Changes to different Mode / State where 'X' is the number of the mode.</li>
</ul>
<ol type="1">
<li><b>S2: Manual Step Input Mode (<span class="tt">FSM::S2_MANUAL_STEP_INPUT</span>)</b> Allows for granular, step-by-step control of the robot's movement using simple character inputs via UART. Commands:</li>
</ol>
<ul>
<li>'A': Move Left</li>
<li>'D': Move Right</li>
<li>'S': Stop Movement</li>
<li>'Q': Launch a ball</li>
<li>'E': Reset launch mechanism</li>
<li>'R': Toggle flywheel motors</li>
<li>'H': Set current IMU heading as home</li>
<li>'T': Exit to Idle Mode</li>
</ul>
<ol type="1">
<li><b>S3: Manual Target Mode (<span class="tt">FSM::S3_MANUAL_TARGET</span>)</b> Enables setting specific position targets for the robot's base and controlling individual motor/servo duties.</li>
</ol>
<ul>
<li><span class="tt">FXXXX</span>: Set target position for Pololu motor 1 (e.g., F1500 for position 1500).</li>
<li><span class="tt">M1FF</span>: Set duty cycle for Motor 1 (flywheel). <span class="tt">FF</span> is a hex value for duty (-100 to 100).</li>
<li><span class="tt">M2FF</span>: Set duty cycle for Motor 2 (base). <span class="tt">FF</span> is a hex value for duty (-100 to 100).</li>
<li><span class="tt">S1FF</span>: Set duty cycle for Servo 1 (launch angle). <span class="tt">FF</span> is a hex value for duty (-100 to 100).</li>
<li><span class="tt">Q</span>: Launch a ball</li>
<li><span class="tt">E</span>: Reset launch mechanism</li>
<li><span class="tt">R</span>: Turn Flywheels On</li>
<li><span class="tt">F</span>: Turn Flywheels Off</li>
<li><span class="tt">T</span>: Exit to Idle Mode</li>
</ul>
<ol type="1">
<li><b>S4: Automatic Mode (<span class="tt">FSM::S4_AUTOMATIC</span>)</b> The robot autonomously uses sensor data (primarily LIDAR) to detect and target ping pong balls for launching. The <span class="tt">main.c</span> currently indicates that pressing 'Q' is needed to start in this mode.</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="components_sec"></a>
Hardware Components</h1>
<ul>
<li><b>STM32F411 Microcontroller:</b> The main processing unit.</li>
<li><b>Geared Motors (Pololu Motors):</b> Used for horizontal positioning of the robot. Controlled via PWM and encoders for feedback.</li>
<li><b>Flywheel Motors:</b> Responsible for imparting velocity to the ping pong ball.</li>
<li><b>Servo Motor:</b> Controls the launch angle or a similar mechanism.</li>
<li><b>LIDAR Sensor (TFLuna):</b> Connected via I2C2, provides distance and intensity data for target detection.</li>
<li><b>IMU Sensor (BNO055):</b> Connected via I2C3, provides orientation data (heading, pitch, roll).</li>
<li><b>Launcher:</b> 3D Printed parts</li>
</ul>
<div class="image">
<img src="tfluna.jpg" alt=""/>
<div class="caption">
TF Luna Lidar Sensor</div></div>
<h1 class="doxsection"><a class="anchor" id="Custom_PCB_sec"></a>
Custom PCB</h1>
<div class="image">
<img src="custom_pcb.jpg" alt=""/>
<div class="caption">
Custom PCB</div></div>
<p>Our Custom PCB features:</p><ul>
<li>STM32F411CEU6 microcontroller</li>
<li>4 x <b>DRV8251</b> Motor Drivers</li>
<li><b>12V</b>, <b>5V</b>, and <b>3.3V</b> rails using a LM22678TJ-ADJ switching regulator and a LMS1587ISX-ADJ-NOPB linear dropout regulator.</li>
<li>The PCB is powered by a 12V 15A power adapter connected via barrel jack.</li>
<li>16 MHz crystal external clock</li>
<li>UART and SWD to connect to the ST-Link.</li>
<li>Two I2C lines to communicate with various peripherals.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="software_modules_sec"></a>
Software Modules</h1>
<p>Overview:</p><ul>
<li>The code attempts to implement separation of concerns. A main.cpp program is used as the entry point of the program. Multiple functions are defined in main.cpp, each called approx every 50ms and each one responsible for integrating with a specific driver.</li>
<li>This approach worked best in the case of the DC motor drivers and servo drivers, as only the motor_dual and motor_t objects needed to be passed between main.cpp and motor_driver.c.</li>
<li>In the case of UART and LIDAR communication, the functionality we wanted was too simple to warrant writing an external driver file. Although, in a project where hardware might change, best practice would have been to separate driver files for these too.</li>
<li>Separating finite state machine (FSM) logic into FSM.cpp did not work well for us. We found that a lot of FSM logic required access to IMU, encoder, or LIDAR data. This meant we had to expose these variables via the extern keyword. This solution felt clunky and really defeated the purpose of having a separate file. FSM probably should have remained in main.cpp.</li>
</ul>
<p>The firmware is structured into several modules:</p><ul>
<li><b>main.c:</b> The entry point of the program, handles peripheral initialization, main loop execution, and UART command parsing. The main loop calls multiple smaller functions which connect with motor and IMU drivers. It also includes multiple functions meant to assist with debugging, which were heavily utilized.</li>
<li><b>fsm.h/fsm<b></b>.cpp:</b> Implements the Finite State Machine that manages the robot's control modes. Is controlled by the set_state() function, called in main.cpp.</li>
<li><b>motor_driver.h/motor_driver<b></b>.cpp:</b> Provides abstractions for controlling the gearmotors and flywheel motors, including PI control for positioning.</li>
<li><b>servo_driver.h/servo_driver<b></b>.cpp:</b> Provides functions for controlling the servo motor.</li>
<li><b>bno055.h/bno055_hal<b></b>.h:</b> Drivers for interfacing with the BNO055 IMU sensor. BNO055 files are provided by Bosch. They connect to the HAL layer via the bno055_hal files.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="Performance_sec"></a>
Performance</h1>
<p>The overall performance of the robot aligned with our expectations, especially considering the time constraints. While the system was able to reliably launch ping pong balls, achieving precise targeting remained a challenge. This inconsistency can be attributed to limitations in the launching mechanism and the absence of a vertical gearmotor. Due to hardware issues encountered during PCB debugging and rework, two of our motor drivers became non-functional. As a result, we prioritized horizontal positioning and flywheel control, deeming the vertical gearmotor the least critical. With access to a third functional motor driver, more accurate targeting through vertical adjustment would have been feasible.</p>
<h1 class="doxsection"><a class="anchor" id="features_objectives_sec"></a>
Features and Objectives</h1>
<p>At the beginning of the project, we identified several key features and objectives for the robot's functionality:</p><ul>
<li>Utilize the <b>LIDAR</b> sensor to detect the presence of a plastic cup.</li>
<li>Use the <b>IMU</b> for a homing mechanism.</li>
<li>Enable manual <b>positioning</b> of the robot using keyboard inputs (e.g., 'A' and 'D' keys).</li>
<li>Implement a mechanism for reliably <b>launching</b> a ping pong ball toward the target.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="Challenges_sec"></a>
Challenges and Workarounds</h1>
<p>One significant challenge we faced was that we were initially unable to drive the motors using the pinouts. We spent several days debugging the motor drivers because we were unsure why our motors did not spin. We initially thought that the issue was that our motor drivers were broken because the schematic was correct according to the DRV8251 datasheet. We then were able to spin the motors by applying a PWM signal to one of the leads of the motor and grounding the other, but we were unable to spin the motor if both OUT1 and OUT2 pins were connected to the motor driver. We then realized that the issue was related to the current draw of the motor because the motor driver disabled if the motor was connected to both OUT1 / OUT2 pins. We then discovered that the shunt resistor was 200 Ohms instead of 0.2 Ohms, which effectively resulted in a trip current threshold of ~0.001 A. We then removed the resistors and soldered the pads together with lead, which resulted in a resistance of ~0.3 Ohms and an acceptable current threshold.</p>
<p>Because two of our four motor drivers were rendered non-functional, we needed to find new pins capable of PWM to control our motors. We ultimately chose to drive both of our flywheels from one motor driver, allowing the remaining functioning driver to control the heading motor.</p>
<p>Early on we decided to utilize Bosch's official BNO055 driver, which they provide via Github. This proved challenging to integrate with our code as the architecture of the driver was more complex than anything we had encountered in class. While very capable, the driver ended up being much more than we needed for this project. It is unclear if utilizing the Bosch driver was better than writing our own.</p>
<h1 class="doxsection"><a class="anchor" id="Mistakes_and_Future_Improvements_sec"></a>
Mistakes and Future Improvements</h1>
<ul>
<li>Check the correct values for components on the order form.</li>
<li>Use Polygons for output pins on a motor driver in addition to the Vm pin.</li>
<li>Make PCB larger to make reworking easier.</li>
<li>Try not to place vias close to other pins/traces.</li>
<li>Add all possible pins on the microcontroller for flexibility.</li>
<li>Use connectors instead of dupont wires.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="setup_sec"></a>
Setup and Build</h1>
<p>For detailed instructions on setting up the development environment, flashing the firmware, and building the project, please refer to the project's README.md or specific build documentation.</p>
<h2 class="doxsection"><a class="anchor" id="file_structure"></a>
Project File Structure</h2>
<pre class="fragment">* .
* ├── Core
* │   ├── Inc
* │   │   ├── main.h
* │   │   └── stm32f4xx_hal_conf.h
* │   └── Src
* │       ├── main.c
* │       ├── stm32f4xx_hal_msp.c
* │       └── stm32f4xx_it.c
* ├── Drivers
* │   ├── BNO055
* │   │   ├── bno055.h
* │   │   └── bno055_hal.h
* │   └── ... (Other peripheral drivers)
* ├── custom_drivers
* │   ├── fsm.h
* │   ├── fsm.cpp
* │   ├── motor_driver.h
* │   ├── motor_driver.cpp
* │   ├── servo_driver.h
* │   └── servo_driver.cpp
* └── Doxyfile (Your Doxygen configuration file)
* </pre><h1 class="doxsection"><a class="anchor" id="quick_links"></a>
Quick Links</h1>
<ul>
<li><a class="el" href="class_f_s_m.html">Finite State Machine (FSM) Documentation</a></li>
<li>Motor Driver Documentation</li>
<li>Servo Driver Documentation</li>
<li>BNO055 IMU Driver Documentation</li>
<li>LIDAR Sensor Interface </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
